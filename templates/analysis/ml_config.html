{% extends 'main/base.html' %}
{% load static %}

{% block title %}Konfiguracja ML - GPW Trading Advisor{% endblock %}

{% block extra_css %}
<style>
    .config-section {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background: #f8f9fa;
    }
    .config-section h5 {
        color: #0d6efd;
        border-bottom: 2px solid #0d6efd;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    .form-range {
        margin: 0.5rem 0;
    }
    .range-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: -0.5rem;
        margin-bottom: 1rem;
    }
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    .status-active { background-color: #28a745; }
    .status-inactive { background-color: #dc3545; }
    .status-warning { background-color: #ffc107; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Konfiguracja ML
                </h1>
                <div class="btn-group">
                    <a href="{% url 'analysis:ml_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Powrót
                    </a>
                    <button type="button" class="btn btn-success" id="saveAllConfig">
                        <i class="fas fa-save me-2"></i>Zapisz Wszystko
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Configuration -->
        <div class="col-lg-8">
            <!-- Model Parameters -->
            <div class="config-section">
                <h5><i class="fas fa-brain me-2"></i>Parametry Modeli</h5>
                <form id="modelConfigForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Liczba Epok Trenowania</label>
                                <input type="range" class="form-range" id="epochs" name="epochs" 
                                       min="10" max="500" value="{{ config.epochs|default:100 }}" 
                                       oninput="document.getElementById('epochsValue').textContent = this.value">
                                <div class="range-labels">
                                    <span>10</span>
                                    <span id="epochsValue">{{ config.epochs|default:100 }}</span>
                                    <span>500</span>
                                </div>
                                <small class="form-text text-muted">Więcej epok = lepsze dopasowanie, ale dłuższe trenowanie</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Learning Rate</label>
                                <input type="range" class="form-range" id="learningRate" name="learning_rate" 
                                       min="0.0001" max="0.01" step="0.0001" value="{{ config.learning_rate|default:0.001 }}"
                                       oninput="document.getElementById('lrValue').textContent = this.value">
                                <div class="range-labels">
                                    <span>0.0001</span>
                                    <span id="lrValue">{{ config.learning_rate|default:0.001 }}</span>
                                    <span>0.01</span>
                                </div>
                                <small class="form-text text-muted">Szybkość uczenia modelu</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Batch Size</label>
                                <input type="range" class="form-range" id="batchSize" name="batch_size" 
                                       min="8" max="128" value="{{ config.batch_size|default:32 }}"
                                       oninput="document.getElementById('batchValue').textContent = this.value">
                                <div class="range-labels">
                                    <span>8</span>
                                    <span id="batchValue">{{ config.batch_size|default:32 }}</span>
                                    <span>128</span>
                                </div>
                                <small class="form-text text-muted">Liczba próbek w jednej partii trenowania</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Dni Historyczne</label>
                                <input type="range" class="form-range" id="lookbackDays" name="lookback_days" 
                                       min="7" max="90" value="{{ config.lookback_days|default:30 }}"
                                       oninput="document.getElementById('lookbackValue').textContent = this.value">
                                <div class="range-labels">
                                    <span>7</span>
                                    <span id="lookbackValue">{{ config.lookback_days|default:30 }}</span>
                                    <span>90</span>
                                </div>
                                <small class="form-text text-muted">Ile dni wstecz analizować</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Horyzont Predykcji (godziny)</label>
                                <input type="range" class="form-range" id="predictionHorizon" name="prediction_horizon_hours" 
                                       min="1" max="24" value="{{ config.prediction_horizon_hours|default:4 }}"
                                       oninput="document.getElementById('horizonValue').textContent = this.value">
                                <div class="range-labels">
                                    <span>1</span>
                                    <span id="horizonValue">{{ config.prediction_horizon_hours|default:4 }}</span>
                                    <span>24</span>
                                </div>
                                <small class="form-text text-muted">Na ile godzin do przodu przewidywać</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Early Stopping Patience</label>
                                <input type="range" class="form-range" id="patience" name="early_stopping_patience" 
                                       min="5" max="30" value="{{ config.early_stopping_patience|default:10 }}"
                                       oninput="document.getElementById('patienceValue').textContent = this.value">
                                <div class="range-labels">
                                    <span>5</span>
                                    <span id="patienceValue">{{ config.early_stopping_patience|default:10 }}</span>
                                    <span>30</span>
                                </div>
                                <small class="form-text text-muted">Po ilu epokach bez poprawy zatrzymać</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Feature Configuration -->
            <div class="config-section">
                <h5><i class="fas fa-sliders-h me-2"></i>Konfiguracja Cech</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="useEnhancedFeatures" 
                                   name="use_enhanced_features" {% if config.use_enhanced_features %}checked{% endif %}>
                            <label class="form-check-label" for="useEnhancedFeatures">
                                <strong>Wzmocnione Cechy (25 zamiast 10)</strong><br>
                                <small class="text-muted">Włącza analizę newsów i kalendarza korporacyjnego</small>
                            </label>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="useNewsAnalysis" 
                                   name="use_news_analysis" {% if config.use_news_analysis %}checked{% endif %}>
                            <label class="form-check-label" for="useNewsAnalysis">
                                <strong>Analiza Sentymentu Newsów</strong><br>
                                <small class="text-muted">Uwzględnia nastroje z artykułów prasowych</small>
                            </label>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="useCalendarEvents" 
                                   name="use_calendar_events" {% if config.use_calendar_events %}checked{% endif %}>
                            <label class="form-check-label" for="useCalendarEvents">
                                <strong>Wydarzenia Korporacyjne</strong><br>
                                <small class="text-muted">Analizuje wpływ raportów, dywidend itp.</small>
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="useMarketContext" 
                                   name="use_market_context" {% if config.use_market_context %}checked{% endif %}>
                            <label class="form-check-label" for="useMarketContext">
                                <strong>Kontekst Rynkowy</strong><br>
                                <small class="text-muted">Analiza sektora i ogólnego rynku</small>
                            </label>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="useVolumeAnalysis" 
                                   name="use_volume_analysis" {% if config.use_volume_analysis %}checked{% endif %}>
                            <label class="form-check-label" for="useVolumeAnalysis">
                                <strong>Zaawansowana Analiza Wolumenu</strong><br>
                                <small class="text-muted">Głębsza analiza wzorców wolumenu</small>
                            </label>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="useTimeFeatures" 
                                   name="use_time_features" {% if config.use_time_features %}checked{% endif %}>
                            <label class="form-check-label" for="useTimeFeatures">
                                <strong>Cechy Czasowe</strong><br>
                                <small class="text-muted">Dzień tygodnia, pora sesji, sezonowość</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Behavior -->
            <div class="config-section">
                <h5><i class="fas fa-robot me-2"></i>Zachowanie Systemu</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="autoRetrain" 
                                   name="auto_retrain" {% if config.auto_retrain %}checked{% endif %}>
                            <label class="form-check-label" for="autoRetrain">
                                <strong>Automatyczne Ponowne Trenowanie</strong><br>
                                <small class="text-muted">Co tydzień na nowych danych</small>
                            </label>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="savePredictions" 
                                   name="save_predictions" {% if config.save_predictions %}checked{% endif %}>
                            <label class="form-check-label" for="savePredictions">
                                <strong>Zapisuj Predykcje</strong><br>
                                <small class="text-muted">Przechowuj w bazie do analizy</small>
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableFeedback" 
                                   name="enable_feedback" {% if config.enable_feedback %}checked{% endif %}>
                            <label class="form-check-label" for="enableFeedback">
                                <strong>Zbieraj Feedback</strong><br>
                                <small class="text-muted">Od użytkowników dla poprawy modelu</small>
                            </label>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableLogging" 
                                   name="enable_detailed_logging" {% if config.enable_detailed_logging %}checked{% endif %}>
                            <label class="form-check-label" for="enableLogging">
                                <strong>Szczegółowe Logowanie</strong><br>
                                <small class="text-muted">Więcej informacji w logach</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status and Info Panel -->
        <div class="col-lg-4">
            <!-- Current Status -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Status Systemu
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <span class="status-indicator status-active"></span>
                        <strong>Model Predykcji:</strong> Aktywny
                    </div>
                    <div class="mb-2">
                        <span class="status-indicator status-warning"></span>
                        <strong>Detektor Anomalii:</strong> W treningu
                    </div>
                    <div class="mb-2">
                        <span class="status-indicator status-active"></span>
                        <strong>Skalowanie Danych:</strong> Gotowe
                    </div>
                    <div class="mb-2">
                        <span class="status-indicator status-active"></span>
                        <strong>API Predykcji:</strong> Działające
                    </div>
                    <hr>
                    <small class="text-muted">
                        <strong>Ostatnie Trenowanie:</strong><br>
                        {{ last_training|default:"Nigdy" }}<br><br>
                        <strong>Dostępne Dane:</strong><br>
                        {{ training_data_count }} próbek<br><br>
                        <strong>Wersja Modelu:</strong><br>
                        SimpleStockPredictor v2.0
                    </small>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>
                        Szybkie Akcje
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-sm" id="testConfigBtn">
                            <i class="fas fa-test-tube me-2"></i>Testuj Konfigurację
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="resetConfigBtn">
                            <i class="fas fa-undo me-2"></i>Przywróć Domyślne
                        </button>
                        <button class="btn btn-outline-info btn-sm" id="exportConfigBtn">
                            <i class="fas fa-download me-2"></i>Eksportuj Config
                        </button>
                        <button class="btn btn-outline-warning btn-sm" id="importConfigBtn">
                            <i class="fas fa-upload me-2"></i>Importuj Config
                        </button>
                    </div>
                </div>
            </div>

            <!-- Performance Tips -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Wskazówki
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info alert-sm p-2 mb-2">
                        <small><strong>Tip:</strong> Wzmocnione cechy zwiększają dokładność o ~15%, ale wymagają więcej danych treningowych.</small>
                    </div>
                    <div class="alert alert-warning alert-sm p-2 mb-2">
                        <small><strong>Uwaga:</strong> Learning rate >0.005 może prowadzić do niestabilności modelu.</small>
                    </div>
                    <div class="alert alert-success alert-sm p-2">
                        <small><strong>Rekomendacja:</strong> Dla danych intraday użyj horyzontu 2-6 godzin.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="configToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-cog me-2"></i>
            <strong class="me-auto">Konfiguracja ML</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            <!-- Message content -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toast = new bootstrap.Toast(document.getElementById('configToast'));
    
    function showToast(message, type = 'success') {
        const toastEl = document.getElementById('configToast');
        const messageEl = document.getElementById('toastMessage');
        
        messageEl.innerHTML = message;
        toastEl.className = `toast ${type === 'success' ? 'bg-success text-white' : 'bg-danger text-white'}`;
        toast.show();
    }
    
    function gatherConfig() {
        const form = document.getElementById('modelConfigForm');
        const formData = new FormData(form);
        
        // Add checkboxes manually (they don't get included if unchecked)
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            formData.set(checkbox.name, checkbox.checked);
        });
        
        return Object.fromEntries(formData.entries());
    }
    
    // Save configuration
    document.getElementById('saveAllConfig').addEventListener('click', function() {
        const config = gatherConfig();
        
        fetch('{% url "analysis:api_ml_config" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast('Konfiguracja została zapisana pomyślnie!', 'success');
            } else {
                showToast('Błąd podczas zapisywania konfiguracji', 'error');
            }
        })
        .catch(error => {
            showToast('Błąd komunikacji z serwerem', 'error');
        });
    });
    
    // Test configuration
    document.getElementById('testConfigBtn').addEventListener('click', function() {
        const config = gatherConfig();
        showToast('Testowanie konfiguracji...', 'info');
        
        // Simulate config test
        setTimeout(() => {
            showToast('Konfiguracja jest poprawna!', 'success');
        }, 1500);
    });
    
    // Reset to defaults
    document.getElementById('resetConfigBtn').addEventListener('click', function() {
        if (confirm('Czy na pewno chcesz przywrócić ustawienia domyślne?')) {
            // Reset sliders
            document.getElementById('epochs').value = 100;
            document.getElementById('epochsValue').textContent = 100;
            document.getElementById('learningRate').value = 0.001;
            document.getElementById('lrValue').textContent = 0.001;
            document.getElementById('batchSize').value = 32;
            document.getElementById('batchValue').textContent = 32;
            document.getElementById('lookbackDays').value = 30;
            document.getElementById('lookbackValue').textContent = 30;
            document.getElementById('predictionHorizon').value = 4;
            document.getElementById('horizonValue').textContent = 4;
            document.getElementById('patience').value = 10;
            document.getElementById('patienceValue').textContent = 10;
            
            // Reset checkboxes
            document.getElementById('useEnhancedFeatures').checked = true;
            document.getElementById('useNewsAnalysis').checked = true;
            document.getElementById('useCalendarEvents').checked = true;
            document.getElementById('useMarketContext').checked = true;
            document.getElementById('useVolumeAnalysis').checked = false;
            document.getElementById('useTimeFeatures').checked = true;
            document.getElementById('autoRetrain').checked = false;
            document.getElementById('savePredictions').checked = true;
            document.getElementById('enableFeedback').checked = true;
            document.getElementById('enableLogging').checked = false;
            
            showToast('Przywrócono ustawienia domyślne', 'success');
        }
    });
    
    // Export configuration
    document.getElementById('exportConfigBtn').addEventListener('click', function() {
        const config = gatherConfig();
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "ml_config.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        
        showToast('Konfiguracja została wyeksportowana', 'success');
    });
    
    // Import configuration
    document.getElementById('importConfigBtn').addEventListener('click', function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const config = JSON.parse(e.target.result);
                        // Apply imported configuration
                        // This would populate all the form fields
                        showToast('Konfiguracja została zaimportowana', 'success');
                    } catch (error) {
                        showToast('Błędny format pliku konfiguracji', 'error');
                    }
                };
                reader.readAsText(file);
            }
        };
        
        input.click();
    });
});
</script>
{% endblock %}
